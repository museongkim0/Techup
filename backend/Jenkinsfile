// Ï†ÑÏó≠ Î≥ÄÏàò ÏÑ†Ïñ∏
// JenkinsÏóêÏÑúÎäî pipeline Î∏îÎ°ù Î∞îÍπ•Ïóê ÏÑ†Ïñ∏Ìï¥Ïïº Ï†ÑÏó≠ÏúºÎ°ú ÏÇ¨Ïö© Í∞ÄÎä•
def deployColor = ""
def otherColor = ""
def startTime = 0

def sendDiscordMessage(String title, String description, String color) {
    withCredentials([string(credentialsId: 'Discord-Webhook', variable: 'DISCORD')]) {
        discordSend(
            description: description,
            footer: "Jenkins CI/CD",
            link: env.BUILD_URL,
            result: currentBuild.currentResult,
            title: title,
            color: color,
            webhookURL: "$DISCORD"
        )
    }
}

pipeline {
    agent any

    options {
        timestamps()
    }

    environment {
        IMAGE_NAME = 'mstar228/techup-backend'
        IMAGE_TAG = "2.0.${BUILD_NUMBER}"
        PATH = "/usr/local/bin:${env.PATH}"
        // ÌÅ¨Î¶¨Îç¥ÏÖúÏóêÏÑú ÌôòÍ≤Ω Î≥ÄÏàò Í∞ÄÏ†∏Ïò§Í∏∞
        DB_URL = credentials('DB_URL')
        DB_USERNAME = credentials('DB_USERNAME')
        DB_PASSWORD = credentials('DB_PASSWORD')
        JWT_SECRET = credentials('JWT_SECRET')
        JWT_EXPIRATION = credentials('JWT_EXPIRATION')
        BACKEND_URL = credentials('BACKEND_URL')
        EC2_HOST = "ubuntu@${BACKEND_URL}"
        KAKAO_CLIENT_ID     = credentials('KAKAO_CLIENT_ID')
        KAKAO_REDIRECT_URI  = credentials('KAKAO_REDIRECT_URI')
        PORTONE_CHANNEL_KEY= credentials('PORTONE_CHANNEL_KEY')
        PORTONE_SECRET     = credentials('PORTONE_SECRET')
        PORTONE_STOREID    = credentials('PORTONE_STOREID')
        MAIL_ADDR          = credentials('MAIL_ADDR')
        MAIL_PASSWORD      = credentials('MAIL_PASSWORD')
        AWS_REGION      = credentials('AWS_REGION')
        AWS_SECRET_KEY      = credentials('AWS_SECRET_KEY')
        AWS_ACCESS_KEY      = credentials('AWS_ACCESS_KEY')
        AWS_S3_BUCKET      = credentials('AWS_S3_BUCKET')

        // kubernetes ÌôòÍ≤ΩÎ≥ÄÏàò
        KUBE_HOST = credentials('KUBE_HOST')
    }

    stages {
        stage('Start Timer') {
            steps {
                script {
                    startTime = System.currentTimeMillis()
                }
            }
        }

        stage('Git Clone') {
            steps {
                echo "GIT_BRANCH: ${env.GIT_BRANCH}"
                echo "Cloning Repository"
                git url: 'https://github.com/beyond-sw-camp/be12-fin-404Found-Tech-Up-BE.git',
                    branch: "${env.GIT_BRANCH.replace('origin/', '')}"
            }
        }

        stage('Gradle Build') {
            steps {
                echo "Building Project"
                sh '''
                    echo "Add Permission"
                    chmod +x ${WORKSPACE}/backend/gradlew
                    echo "Cleaning previous build"
                    rm -rf ${WORKSPACE}/backend/build
                    echo "Running Gradle build"
                    cd ${WORKSPACE}/backend && ./gradlew bootJar
                '''
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    echo "Building Docker Image ${IMAGE_NAME}:${IMAGE_TAG}"
                    docker.build("${IMAGE_NAME}:${IMAGE_TAG}", "${WORKSPACE}/backend")
                }
            }
        }

        stage('Push to Registry') {
            steps {
                script {
                    echo "Pushing Docker Image ${IMAGE_NAME}:${IMAGE_TAG} to Registry"
                    withDockerRegistry([credentialsId: 'DOCKER_HUB']) {
                        docker.image("${IMAGE_NAME}:${IMAGE_TAG}").push()
                        docker.image("${IMAGE_NAME}:${IMAGE_TAG}").push('latest')
                    }
                }
            }
        }

        // stage('Deploy to EC2') {
        //     when {
        //         expression { env.GIT_BRANCH == 'origin/main' }
        //     }
        //     steps {
        //         script {
        //             echo "MODIFY DOCKER-COMPOSE.YML"
        //             sh """
        //                 sed -i 's|mstar228/techup-backend:latest|mstar228/techup-backend:${IMAGE_TAG}|' ${WORKSPACE}/backend/docker-compose.yml
        //             """

        //             echo "CREATE .ENV"
        //             sh """
        //                 ssh -o StrictHostKeyChecking=no ${EC2_HOST} <<EOF
        //                 cat > /home/ubuntu/.env <<EOL
        //                 DB_URL=${DB_URL}
        //                 DB_USERNAME=${DB_USERNAME}
        //                 DB_PASSWORD=${DB_PASSWORD}
        //                 JWT_SECRET=${JWT_SECRET}
        //                 JWT_EXPIRATION=${JWT_EXPIRATION}
        //                 KAKAO_CLIENT_ID=${KAKAO_CLIENT_ID}
        //                 KAKAO_REDIRECT_URI=${KAKAO_REDIRECT_URI}
        //                 PORTONE_CHANNEL_KEY=${PORTONE_CHANNEL_KEY}
        //                 PORTONE_SECRET=${PORTONE_SECRET}
        //                 PORTONE_STOREID=${PORTONE_STOREID}
        //                 MAIL_ADDR=${MAIL_ADDR}
        //                 MAIL_PASSWORD=${MAIL_PASSWORD}
        //                 AWS_REGION=${AWS_REGION}
        //                 AWS_SECRET_KEY=${AWS_SECRET_KEY}
        //                 AWS_ACCESS_KEY=${AWS_ACCESS_KEY}
        //                 AWS_S3_BUCKET=${AWS_S3_BUCKET}
        //             """

        //             echo "SCP DOCKER-COMPOSE.YML"
        //             sh """
        //                 ssh -o StrictHostKeyChecking=no ${EC2_HOST} "[ -f /home/ubuntu/docker-compose.yml ] && echo 'File exists, overwriting' || echo 'File does not exist'"
        //                 scp -o StrictHostKeyChecking=no ${WORKSPACE}/backend/docker-compose.yml ${EC2_HOST}:/home/ubuntu/docker-compose.yml
        //             """

        //             echo "RUN DOCKER-COMPOSE"
        //             sh """
        //                 ssh -o StrictHostKeyChecking=no ${EC2_HOST} <<'EOF'
        //                 docker-compose -f /home/ubuntu/docker-compose.yml down  # Í∏∞Ï°¥ Ïª®ÌÖåÏù¥ÎÑà Ï§ëÏßÄ Î∞è ÏÇ≠Ï†ú
        //                 docker-compose -f /home/ubuntu/docker-compose.yml up -d  # ÏÉà Ïª®ÌÖåÏù¥ÎÑà Ïã§Ìñâ
        //             """
        //         }
        //     }
        // }

        stage('Determine Deploy Color') {
            when {
                expression { env.GIT_BRANCH == 'origin/main' }
            }
            steps {
                script {
                    def blueReplicas = sh(
                        script: "ssh ${KUBE_HOST} 'kubectl get deployment backend-deployment-blue -o jsonpath=\"{.spec.replicas}\"' || echo '0'",
                        returnStdout: true
                    ).trim()
                    def greenReplicas = sh(
                        script: "ssh ${KUBE_HOST} 'kubectl get deployment backend-deployment-green -o jsonpath=\"{.spec.replicas}\"' || echo '0'",
                        returnStdout: true
                    ).trim()

                    int blueCount = 0
                    int greenCount = 0
                    try { blueCount = blueReplicas.toInteger() } catch (Exception e) {}
                    try { greenCount = greenReplicas.toInteger() } catch (Exception e) {}

                    if (blueCount > 0 && greenCount == 0) {
                        deployColor = "green"
                        otherColor = "blue"
                    } else if (greenCount > 0 && blueCount == 0) {
                        deployColor = "blue"
                        otherColor = "green"
                    } else if (blueCount > 0 && greenCount > 0) {
                        deployColor = "green"
                        otherColor = "blue"
                    } else {
                        deployColor = "blue"
                        otherColor = "green"
                    }

                    echo "Deploying ${deployColor} version (scaling down ${otherColor})"
                }
            }
            post {
                success {
                    sendDiscordMessage("‚úÖ Î∞∞Ìè¨ ÏÉâÏÉÅ Í≤∞Ï†ï ÏôÑÎ£å!", "${deployColor}Î°ú Î∞∞Ìè¨ ÏßÑÌñâ ÏòàÏ†ï", "GREEN")
                }
                failure {
                    sendDiscordMessage("‚ùå Î∞∞Ìè¨ ÏÉâÏÉÅ Í≤∞Ï†ï Ïã§Ìå®!", "replica ÌôïÏù∏ Ï§ë Ïò§Î•ò Î∞úÏÉù", "RED")
                }
            }
        }

        stage('Deploy Blue-Green') {
            when {
                expression { env.GIT_BRANCH == 'origin/main' }
            }
            steps {
                script {
                    sh """
                        sed -i "s/latest/${IMAGE_TAG}/g" ${WORKSPACE}/backend/k8s/backend-deployment-${deployColor}.yml
                        sed -i "s/latest/${IMAGE_TAG}/g" ${WORKSPACE}/backend/k8s/backend-cm.yml
                        sed -i "s/latest/${IMAGE_TAG}/g" ${WORKSPACE}/backend/k8s/backend-svc.yml
                        scp ${WORKSPACE}/backend/k8s/backend-deployment-${deployColor}.yml ${KUBE_HOST}:/home/test/backend/k8s/
                        scp ${WORKSPACE}/backend/k8s/backend-cm.yml ${KUBE_HOST}:/home/test/backend/k8s/
                        scp ${WORKSPACE}/backend/k8s/backend-svc.yml ${KUBE_HOST}:/home/test/backend/k8s/
                        ssh ${KUBE_HOST} 'kubectl apply -f /home/test/backend/k8s/backend-cm.yml'
                        ssh ${KUBE_HOST} 'kubectl apply -f /home/test/backend/k8s/backend-svc.yml'
                        ssh ${KUBE_HOST} 'kubectl apply -f /home/test/backend/k8s/backend-deployment-${deployColor}.yml'
                        ssh ${KUBE_HOST} 'kubectl rollout status deployment/backend-deployment-${deployColor}'
                    """
                }
            }
            post {
                success {
                    sendDiscordMessage("‚úÖ Blue-Green Î∞∞Ìè¨ ÏÑ±Í≥µ!", "${deployColor} Î∞∞Ìè¨ ÏôÑÎ£å", "GREEN")
                }
                failure {
                    sendDiscordMessage("‚ùå Blue-Green Î∞∞Ìè¨ Ïã§Ìå®!", "Î∞∞Ìè¨ Ï§ë Ïò§Î•ò Î∞úÏÉù", "RED")
                }
            }
        }

        stage('Stabilization Period') {
            when {
                expression { env.GIT_BRANCH == 'origin/main' }
            }
            steps {
                script {
                    echo "Waiting for deployment to stabilize..."
                    // 60Ï¥à ÎèôÏïà ÏÉà Î∞∞Ìè¨Í∞Ä ÏïàÏ†ïÌôîÎê† ÏãúÍ∞ÑÏùÑ Ï†úÍ≥µ
                    sleep(time: 60, unit: 'SECONDS')
                }
            }
            post {
                success {
                    sendDiscordMessage("‚úÖ ÏïàÏ†ïÌôî Í∏∞Í∞Ñ ÏôÑÎ£å!", "ÏÉà Î∞∞Ìè¨Ïùò ÏïàÏ†ïÌôî ÏãúÍ∞ÑÏù¥ Ï¢ÖÎ£åÎêòÏóàÏäµÎãàÎã§", "GREEN")
                }
            }
        }

        stage('Verify Deployment') {
            when {
                expression { env.GIT_BRANCH == 'origin/main' }
            }
            steps {
                script {
                    echo "Verifying deployment health..."

                    // Pod ÏÉÅÌÉú ÌôïÏù∏
                    def podStatus = sh(
                        script: "ssh ${KUBE_HOST} 'kubectl get pods -l deployment=${deployColor},type=backend -o jsonpath=\"{.items[*].status.phase}\"'",
                        returnStdout: true
                    ).trim()

                    // Î™®Îì† ÌååÎìúÍ∞Ä Running ÏÉÅÌÉúÏù∏ÏßÄ ÌôïÏù∏
                    if (!podStatus.contains("Running") || podStatus.contains("Pending") || podStatus.contains("Failed")) {
                        error "Î∞∞Ìè¨ ÏÉÅÌÉú ÌôïÏù∏ Ïã§Ìå®: ÌååÎìúÍ∞Ä Ï†ïÏÉÅÏ†ÅÏúºÎ°ú Ïã§ÌñâÎêòÍ≥† ÏûàÏßÄ ÏïäÏäµÎãàÎã§. ÏÉÅÌÉú: ${podStatus}"
                    }

                    // Pod Ready ÏÉÅÌÉú ÌôïÏù∏
                    def podReady = sh(
                        script: "ssh ${KUBE_HOST} 'kubectl get pods -l deployment=${deployColor},type=backend -o jsonpath=\"{.items[*].status.containerStatuses[0].ready}\"'",
                        returnStdout: true
                    ).trim()

                    if (podReady.contains("false")) {
                        error "Î∞∞Ìè¨ ÏÉÅÌÉú ÌôïÏù∏ Ïã§Ìå®: Ïª®ÌÖåÏù¥ÎÑàÍ∞Ä Ï§ÄÎπÑÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§. ÏÉÅÌÉú: ${podReady}"
                    }

                    // ÏÑúÎπÑÏä§ ÏóîÎìúÌè¨Ïù∏Ìä∏ ÌôïÏù∏ (Spring Boot API Ìó¨Ïä§Ï≤¥ÌÅ¨)
                    try {
                        sh "curl -s --retry 5 --retry-delay 10 -f https://techup-inner.p-e.kr/api/actuator/health || echo 'Health check endpoint not available, but continuing...'"
                    } catch (Exception e) {
                        echo "Note: Health endpoint check failed, but continuing with deployment."
                    }

                    echo "Deployment verification successful!"
                }
            }
            post {
                success {
                    sendDiscordMessage("‚úÖ Î∞∞Ìè¨ Í≤ÄÏ¶ù ÏÑ±Í≥µ!", "Ìó¨Ïä§Ï≤¥ÌÅ¨ ÌÜµÍ≥º", "GREEN")
                }
                failure {
                    sendDiscordMessage("‚ùå Î∞∞Ìè¨ Í≤ÄÏ¶ù Ïã§Ìå®!", "Ìó¨Ïä§Ï≤¥ÌÅ¨ Ïã§Ìå®", "RED")
                    // Î∞∞Ìè¨ Í≤ÄÏ¶ù Ïã§Ìå® Ïãú ÏûêÎèôÏúºÎ°ú Î°§Î∞± Ïä§ÌÖåÏù¥ÏßÄÎ°ú Ïù¥Îèô
                }
            }
        }

        stage('Update Service Selector') {
            when {
                expression { env.GIT_BRANCH == 'origin/main' && currentBuild.resultIsBetterOrEqualTo('SUCCESS') }
            }
            steps {
                script {
                    echo "Updating service selector to deployment: ${deployColor}"
                    sh """
                        echo '{"spec":{"selector":{"deployment":"${deployColor}","type":"backend"}}}' > /tmp/patch2.json
                        scp /tmp/patch2.json ${KUBE_HOST}:/tmp/patch2.json
                        ssh ${KUBE_HOST} "kubectl patch svc backend-svc -p '\$(cat /tmp/patch2.json)'"
                        ssh ${KUBE_HOST} 'rm /tmp/patch2.json'
                        rm /tmp/patch2.json
                    """
                }
            }
            post {
                success {
                    sendDiscordMessage("‚úÖ Ìä∏ÎûòÌîΩ Ï†ÑÌôò ÏÑ±Í≥µ!", "${deployColor}Î°ú Ìä∏ÎûòÌîΩÏù¥ Ï†ÑÌôòÎêòÏóàÏäµÎãàÎã§", "GREEN")
                }
                failure {
                    sendDiscordMessage("‚ùå Ìä∏ÎûòÌîΩ Ï†ÑÌôò Ïã§Ìå®!", "ÏÑúÎπÑÏä§ ÏÖÄÎ†âÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®", "RED")
                }
            }
        }

        stage('Scale Down Other Deployment') {
            when {
                expression { env.GIT_BRANCH == 'origin/main' && currentBuild.resultIsBetterOrEqualTo('SUCCESS') }
            }
            steps {
                script {
                    echo "Scaling down ${otherColor} deployment"
                    sh """
                        ssh ${KUBE_HOST} 'kubectl scale deployment backend-deployment-${otherColor} --replicas=0' || true
                    """
                }
            }
            post {
                success {
                    sendDiscordMessage("‚úÖ Ïù¥Ï†Ñ Î∞∞Ìè¨ Ïä§ÏºÄÏùº Îã§Ïö¥ ÏôÑÎ£å!", "${otherColor} Î∞∞Ìè¨Í∞Ä Ïä§ÏºÄÏùº Îã§Ïö¥ÎêòÏóàÏäµÎãàÎã§", "GREEN")
                }
                failure {
                    sendDiscordMessage("‚ö†Ô∏è Ïù¥Ï†Ñ Î∞∞Ìè¨ Ïä§ÏºÄÏùº Îã§Ïö¥ Ïã§Ìå®!", "${otherColor} Î∞∞Ìè¨ Ïä§ÏºÄÏùº Îã§Ïö¥ Ï§ë Î¨∏Ï†ú Î∞úÏÉù", "YELLOW")
                }
            }
        }

        stage('Rollback if Needed') {
            when {
                expression {
                    env.GIT_BRANCH == 'origin/main' &&
                    (currentBuild.currentResult == 'UNSTABLE' || currentBuild.currentResult == 'FAILURE')
                }
            }
            steps {
                script {
                    echo "Deployment failed, rolling back to ${otherColor}"
                    sh """
                        # Ïù¥Ï†Ñ Î∞∞Ìè¨ Î≥µÍµ¨
                        ssh ${KUBE_HOST} 'kubectl scale deployment backend-deployment-${otherColor} --replicas=1'
                        ssh ${KUBE_HOST} 'kubectl rollout status deployment/backend-deployment-${otherColor}'

                        # ÏÑúÎπÑÏä§ ÏÖÄÎ†âÌÑ∞Î•º Ïù¥Ï†Ñ Î∞∞Ìè¨Î°ú Î≥ÄÍ≤Ω
                        echo '{"spec":{"selector":{"deployment":"${otherColor}","type":"backend"}}}' > /tmp/rollback-patch.json
                        scp /tmp/rollback-patch.json ${KUBE_HOST}:/tmp/rollback-patch.json
                        ssh ${KUBE_HOST} "kubectl patch svc backend-svc -p '\$(cat /tmp/rollback-patch.json)'"
                        ssh ${KUBE_HOST} 'rm /tmp/rollback-patch.json'
                        rm /tmp/rollback-patch.json

                        # Ïã§Ìå®Ìïú Î∞∞Ìè¨ Ïä§ÏºÄÏùº Îã§Ïö¥
                        ssh ${KUBE_HOST} 'kubectl scale deployment backend-deployment-${deployColor} --replicas=0'
                    """
                }
            }
            post {
                success {
                    sendDiscordMessage("‚úÖ Î°§Î∞± ÏÑ±Í≥µ!", "${otherColor}Î°ú Î°§Î∞± ÏôÑÎ£å", "GREEN")
                }
                failure {
                    sendDiscordMessage("üö® Î°§Î∞± Ïã§Ìå®!", "Î°§Î∞± Ï§ë Ïò§Î•ò Î∞úÏÉù, ÏàòÎèô Ï°∞Ïπò ÌïÑÏöî", "RED")
                }
            }
        }

        stage('End Timer') {
            steps {
                script {
                    def endTime = System.currentTimeMillis()
                    def duration = (endTime - startTime) / 1000
                    echo "‚è±Ô∏è Ï†ÑÏ≤¥ ÌååÏù¥ÌîÑÎùºÏù∏ Ïã§Ìñâ ÏãúÍ∞Ñ: ${duration}Ï¥à"
                }
            }
        }
    }

    post {
        success {
            script {
                def endTime = System.currentTimeMillis()
                def duration = (endTime - startTime) / 1000
                sendDiscordMessage("üéâ Ï†ÑÏ≤¥ ÌååÏù¥ÌîÑÎùºÏù∏ ÏÑ±Í≥µ!", "‚è±Ô∏è Ïã§Ìñâ ÏãúÍ∞Ñ: ${duration}Ï¥à", "GREEN")
            }
        }
        failure {
            script {
                def endTime = System.currentTimeMillis()
                def duration = (endTime - startTime) / 1000
                sendDiscordMessage("üö® Ï†ÑÏ≤¥ ÌååÏù¥ÌîÑÎùºÏù∏ Ïã§Ìå®!", "‚è±Ô∏è Ïã§Ìñâ ÏãúÍ∞Ñ: ${duration}Ï¥à", "RED")
            }
        }
    }
}
