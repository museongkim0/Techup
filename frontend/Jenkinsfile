// ì „ì—­ ë³€ìˆ˜ ì„ ì–¸
// Jenkinsì—ì„œëŠ” pipeline ë¸”ë¡ ë°”ê¹¥ì— ì„ ì–¸í•´ì•¼ ì „ì—­ìœ¼ë¡œ ì‚¬ìš© ê°€ëŠ¥
def deployColor = ""
def otherColor = ""
def startTime = 0

def sendDiscordMessage(String title, String description, String color) {
    withCredentials([string(credentialsId: 'Discord-Webhook', variable: 'DISCORD')]) {
        discordSend(
            description: description,
            footer: "Jenkins CI/CD",
            link: env.BUILD_URL,
            result: currentBuild.currentResult,
            title: title,
            color: color,
            webhookURL: "$DISCORD"
        )
    }
}

pipeline {
    agent any

    options {
        timestamps()
    }

    environment {
        IMAGE_NAME = 'mstar228/techup-frontend'
        IMAGE_TAG = "2.0.${BUILD_NUMBER}"
        PATH = "/usr/local/bin:${env.PATH}"

        // EC2 í™˜ê²½ë³€ìˆ˜
        FRONTEND_URL = credentials('FRONTEND_URL')
        BACKEND_URL = credentials('BACKEND_URL')
        EC2_HOST = "ubuntu@${FRONTEND_URL}"

        // kubernetes í™˜ê²½ë³€ìˆ˜
        KUBE_HOST = credentials('KUBE_HOST')
    }

    stages {
        stage('Start Timer') {
            steps {
                script {
                    startTime = System.currentTimeMillis()
                }
            }
        }

        stage('Git Clone') {
            steps {
                echo "Cloning Repository"
                git url: 'https://github.com/beyond-sw-camp/be12-fin-404Found-Tech-Up-FE.git',
                    branch: "${env.GIT_BRANCH.replace('origin/', '')}"
            }
            post {
                success {
                    sendDiscordMessage("âœ… Git Clone ì„±ê³µ!", "Git Repository í´ë¡  ì™„ë£Œ", "GREEN")
                }
                failure {
                    sendDiscordMessage("âŒ Git Clone ì‹¤íŒ¨!", "Git Repository í´ë¡  ì¤‘ ì˜¤ë¥˜ ë°œìƒ", "RED")
                }
            }
        }

        stage('Build Frontend') {
            steps {
                echo "Building Frontend"
                sh '''
                    cd ${WORKSPACE}/techUpFrontend
                    npm install
                    npm run build
                '''
                echo "MODIFY default.conf"
                sh """
                    sed -i 's|\${FRONTEND_URL}|${FRONTEND_URL}|' ${WORKSPACE}/techUpFrontend/nginx/default.conf
                    sed -i 's|\${BACKEND_URL}|${BACKEND_URL}|' ${WORKSPACE}/techUpFrontend/nginx/default.conf
                """
            }
            post {
                success {
                    sendDiscordMessage("âœ… Frontend Build ì„±ê³µ!", "í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ì™„ë£Œ", "GREEN")
                }
                failure {
                    sendDiscordMessage("âŒ Frontend Build ì‹¤íŒ¨!", "í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ", "RED")
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    echo "Building Docker Image ${IMAGE_NAME}:${IMAGE_TAG}"
                    docker.build("${IMAGE_NAME}:${IMAGE_TAG}", "${WORKSPACE}/techUpFrontend")
                }
            }
            post {
                success {
                    sendDiscordMessage("âœ… Docker Build ì„±ê³µ!", "í”„ë¡ íŠ¸ì—”ë“œ ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ", "GREEN")
                }
                failure {
                    sendDiscordMessage("âŒ Docker Build ì‹¤íŒ¨!", "í”„ë¡ íŠ¸ì—”ë“œ ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ", "RED")
                }
            }
        }

        stage('Push to Registry') {
            steps {
                script {
                    echo "Pushing Docker Image ${IMAGE_NAME}:${IMAGE_TAG} to Registry"
                    withDockerRegistry([credentialsId: 'DOCKER_HUB']) {
                        docker.image("${IMAGE_NAME}:${IMAGE_TAG}").push()
                        docker.image("${IMAGE_NAME}:${IMAGE_TAG}").push('latest')
                    }
                }
            }
            post {
                success {
                    sendDiscordMessage("âœ… Docker Push ì„±ê³µ!", "ì´ë¯¸ì§€ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ì—…ë¡œë“œ ì™„ë£Œ", "GREEN")
                }
                failure {
                    sendDiscordMessage("âŒ Docker Push ì‹¤íŒ¨!", "ë ˆì§€ìŠ¤íŠ¸ë¦¬ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ", "RED")
                }
            }
        }

        stage('Determine Deploy Color') {
            when {
                expression { env.GIT_BRANCH == 'origin/main' }
            }
            steps {
                script {
                    def blueReplicas = sh(
                        script: "ssh ${KUBE_HOST} 'kubectl get deployment frontend-deployment-blue -o jsonpath=\"{.spec.replicas}\"' || echo '0'",
                        returnStdout: true
                    ).trim()
                    def greenReplicas = sh(
                        script: "ssh ${KUBE_HOST} 'kubectl get deployment frontend-deployment-green -o jsonpath=\"{.spec.replicas}\"' || echo '0'",
                        returnStdout: true
                    ).trim()

                    int blueCount = 0
                    int greenCount = 0
                    try { blueCount = blueReplicas.toInteger() } catch (Exception e) {}
                    try { greenCount = greenReplicas.toInteger() } catch (Exception e) {}

                    if (blueCount > 0 && greenCount == 0) {
                        deployColor = "green"
                        otherColor = "blue"
                    } else if (greenCount > 0 && blueCount == 0) {
                        deployColor = "blue"
                        otherColor = "green"
                    } else if (blueCount > 0 && greenCount > 0) {
                        deployColor = "green"
                        otherColor = "blue"
                    } else {
                        deployColor = "blue"
                        otherColor = "green"
                    }

                    echo "Deploying ${deployColor} version (scaling down ${otherColor})"
                }
            }
            post {
                success {
                    sendDiscordMessage("âœ… ë°°í¬ ìƒ‰ìƒ ê²°ì • ì™„ë£Œ!", "${deployColor}ë¡œ ë°°í¬ ì§„í–‰ ì˜ˆì •", "GREEN")
                }
                failure {
                    sendDiscordMessage("âŒ ë°°í¬ ìƒ‰ìƒ ê²°ì • ì‹¤íŒ¨!", "replica í™•ì¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ", "RED")
                }
            }
        }

        stage('Deploy Blue-Green') {
            when {
                expression { env.GIT_BRANCH == 'origin/main' }
            }
            steps {
                script {
                    sh """
                        sed -i "s/latest/${IMAGE_TAG}/g" ${WORKSPACE}/techUpFrontend/k8s/frontend-deployment-${deployColor}.yml
                        sed -i "s/latest/${IMAGE_TAG}/g" ${WORKSPACE}/techUpFrontend/k8s/frontend-conf.yml
                        sed -i "s/latest/${IMAGE_TAG}/g" ${WORKSPACE}/techUpFrontend/k8s/frontend-svc.yml
                        scp ${WORKSPACE}/techUpFrontend/k8s/frontend-deployment-${deployColor}.yml ${KUBE_HOST}:/home/test/frontend/k8s/
                        scp ${WORKSPACE}/techUpFrontend/k8s/frontend-conf.yml ${KUBE_HOST}:/home/test/frontend/k8s/
                        scp ${WORKSPACE}/techUpFrontend/k8s/frontend-svc.yml ${KUBE_HOST}:/home/test/frontend/k8s/
                        ssh ${KUBE_HOST} 'kubectl apply -f /home/test/frontend/k8s/frontend-conf.yml'
                        ssh ${KUBE_HOST} 'kubectl apply -f /home/test/frontend/k8s/frontend-svc.yml'
                        ssh ${KUBE_HOST} 'kubectl apply -f /home/test/frontend/k8s/frontend-deployment-${deployColor}.yml'
                        ssh ${KUBE_HOST} 'kubectl rollout status deployment/frontend-deployment-${deployColor}'
                    """
                }
            }
            post {
                success {
                    sendDiscordMessage("âœ… Blue-Green ë°°í¬ ì„±ê³µ!", "${deployColor} ë°°í¬ ì™„ë£Œ", "GREEN")
                }
                failure {
                    sendDiscordMessage("âŒ Blue-Green ë°°í¬ ì‹¤íŒ¨!", "ë°°í¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ", "RED")
                }
            }
        }

        stage('Stabilization Period') {
            when {
                expression { env.GIT_BRANCH == 'origin/main' }
            }
            steps {
                script {
                    echo "Waiting for deployment to stabilize..."
                    // 60ì´ˆ ë™ì•ˆ ìƒˆ ë°°í¬ê°€ ì•ˆì •í™”ë  ì‹œê°„ì„ ì œê³µ
                    sleep(time: 60, unit: 'SECONDS')
                }
            }
            post {
                success {
                    sendDiscordMessage("âœ… ì•ˆì •í™” ê¸°ê°„ ì™„ë£Œ!", "ìƒˆ ë°°í¬ì˜ ì•ˆì •í™” ì‹œê°„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤", "GREEN")
                }
            }
        }

        stage('Verify Deployment') {
            when {
                expression { env.GIT_BRANCH == 'origin/main' }
            }
            steps {
                script {
                    echo "Verifying deployment health..."
                    
                    // Pod ìƒíƒœ í™•ì¸
                    def podStatus = sh(
                        script: "ssh ${KUBE_HOST} 'kubectl get pods -l deployment=${deployColor},type=frontend -o jsonpath=\"{.items[*].status.phase}\"'",
                        returnStdout: true
                    ).trim()
                    
                    // ëª¨ë“  íŒŒë“œê°€ Running ìƒíƒœì¸ì§€ í™•ì¸
                    if (!podStatus.contains("Running") || podStatus.contains("Pending") || podStatus.contains("Failed")) {
                        error "ë°°í¬ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨: íŒŒë“œê°€ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ë˜ê³  ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. ìƒíƒœ: ${podStatus}"
                    }
                    
                    // Pod Ready ìƒíƒœ í™•ì¸
                    def podReady = sh(
                        script: "ssh ${KUBE_HOST} 'kubectl get pods -l deployment=${deployColor},type=frontend -o jsonpath=\"{.items[*].status.containerStatuses[0].ready}\"'",
                        returnStdout: true
                    ).trim()
                    
                    if (podReady.contains("false")) {
                        error "ë°°í¬ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨: ì»¨í…Œì´ë„ˆê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ìƒíƒœ: ${podReady}"
                    }
                    
                    // ì„œë¹„ìŠ¤ ì—”ë“œí¬ì¸íŠ¸ í™•ì¸ (í—¬ìŠ¤ì²´í¬ APIê°€ ìˆë‹¤ë©´)
                    try {
                        sh "curl -s --retry 5 --retry-delay 10 -f https://techup-inner.p-e.kr/health || echo 'Health check endpoint not available, skipping...'"
                    } catch (Exception e) {
                        echo "Note: Health endpoint check skipped or failed, but continuing with deployment."
                    }
                    
                    echo "Deployment verification successful!"
                }
            }
            post {
                success {
                    sendDiscordMessage("âœ… ë°°í¬ ê²€ì¦ ì„±ê³µ!", "í—¬ìŠ¤ì²´í¬ í†µê³¼", "GREEN")
                }
                failure {
                    sendDiscordMessage("âŒ ë°°í¬ ê²€ì¦ ì‹¤íŒ¨!", "í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨", "RED")
                    // ë°°í¬ ê²€ì¦ ì‹¤íŒ¨ ì‹œ ìë™ìœ¼ë¡œ ë¡¤ë°± ìŠ¤í…Œì´ì§€ë¡œ ì´ë™
                }
            }
        }

        stage('Update Service Selector') {
            when {
                expression { env.GIT_BRANCH == 'origin/main' && currentBuild.resultIsBetterOrEqualTo('SUCCESS') }
            }
            steps {
                script {
                    echo "Updating service selector to deployment: ${deployColor}"
                    sh """
                        echo '{"spec":{"selector":{"deployment":"${deployColor}","type":"frontend"}}}' > /tmp/patch.json
                        scp /tmp/patch.json ${KUBE_HOST}:/tmp/patch.json
                        ssh ${KUBE_HOST} "kubectl patch svc frontend-svc -p '\$(cat /tmp/patch.json)'"
                        ssh ${KUBE_HOST} 'rm /tmp/patch.json'
                        rm /tmp/patch.json
                    """
                }
            }
            post {
                success {
                    sendDiscordMessage("âœ… íŠ¸ë˜í”½ ì „í™˜ ì„±ê³µ!", "${deployColor}ë¡œ íŠ¸ë˜í”½ì´ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤", "GREEN")
                }
                failure {
                    sendDiscordMessage("âŒ íŠ¸ë˜í”½ ì „í™˜ ì‹¤íŒ¨!", "ì„œë¹„ìŠ¤ ì…€ë ‰í„° ì—…ë°ì´íŠ¸ ì‹¤íŒ¨", "RED")
                }
            }
        }

        stage('Scale Down Other Deployment') {
            when {
                expression { env.GIT_BRANCH == 'origin/main' && currentBuild.resultIsBetterOrEqualTo('SUCCESS') }
            }
            steps {
                script {
                    echo "Scaling down ${otherColor} deployment"
                    sh """
                        ssh ${KUBE_HOST} 'kubectl scale deployment frontend-deployment-${otherColor} --replicas=0' || true
                    """
                }
            }
            post {
                success {
                    sendDiscordMessage("âœ… ì´ì „ ë°°í¬ ìŠ¤ì¼€ì¼ ë‹¤ìš´ ì™„ë£Œ!", "${otherColor} ë°°í¬ê°€ ìŠ¤ì¼€ì¼ ë‹¤ìš´ë˜ì—ˆìŠµë‹ˆë‹¤", "GREEN")
                }
                failure {
                    sendDiscordMessage("âš ï¸ ì´ì „ ë°°í¬ ìŠ¤ì¼€ì¼ ë‹¤ìš´ ì‹¤íŒ¨!", "${otherColor} ë°°í¬ ìŠ¤ì¼€ì¼ ë‹¤ìš´ ì¤‘ ë¬¸ì œ ë°œìƒ", "YELLOW")
                }
            }
        }

        stage('Rollback if Needed') {
            when {
                expression { 
                    env.GIT_BRANCH == 'origin/main' && 
                    (currentBuild.currentResult == 'UNSTABLE' || currentBuild.currentResult == 'FAILURE')
                }
            }
            steps {
                script {
                    echo "Deployment failed, rolling back to ${otherColor}"
                    sh """
                        # ì´ì „ ë°°í¬ ë³µêµ¬
                        ssh ${KUBE_HOST} 'kubectl scale deployment frontend-deployment-${otherColor} --replicas=1'
                        ssh ${KUBE_HOST} 'kubectl rollout status deployment/frontend-deployment-${otherColor}'
                        
                        # ì„œë¹„ìŠ¤ ì…€ë ‰í„°ë¥¼ ì´ì „ ë°°í¬ë¡œ ë³€ê²½
                        echo '{"spec":{"selector":{"deployment":"${otherColor}","type":"frontend"}}}' > /tmp/rollback-patch.json
                        scp /tmp/rollback-patch.json ${KUBE_HOST}:/tmp/rollback-patch.json
                        ssh ${KUBE_HOST} "kubectl patch svc frontend-svc -p '\$(cat /tmp/rollback-patch.json)'"
                        ssh ${KUBE_HOST} 'rm /tmp/rollback-patch.json'
                        rm /tmp/rollback-patch.json
                        
                        # ì‹¤íŒ¨í•œ ë°°í¬ ìŠ¤ì¼€ì¼ ë‹¤ìš´
                        ssh ${KUBE_HOST} 'kubectl scale deployment frontend-deployment-${deployColor} --replicas=0'
                    """
                }
            }
            post {
                success {
                    sendDiscordMessage("âœ… ë¡¤ë°± ì„±ê³µ!", "${otherColor}ë¡œ ë¡¤ë°± ì™„ë£Œ", "GREEN")
                }
                failure {
                    sendDiscordMessage("ğŸš¨ ë¡¤ë°± ì‹¤íŒ¨!", "ë¡¤ë°± ì¤‘ ì˜¤ë¥˜ ë°œìƒ, ìˆ˜ë™ ì¡°ì¹˜ í•„ìš”", "RED")
                }
            }
        }

        stage('End Timer') {
            steps {
                script {
                    def endTime = System.currentTimeMillis()
                    def duration = (endTime - startTime) / 1000
                    echo "â±ï¸ ì „ì²´ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ì‹œê°„: ${duration}ì´ˆ"
                }
            }
        }
    }

    post {
        success {
            script {
                def endTime = System.currentTimeMillis()
                def duration = (endTime - startTime) / 1000
                sendDiscordMessage("ğŸ‰ ì „ì²´ íŒŒì´í”„ë¼ì¸ ì„±ê³µ!", "â±ï¸ ì‹¤í–‰ ì‹œê°„: ${duration}ì´ˆ", "GREEN")
            }
        }
        failure {
            script {
                def endTime = System.currentTimeMillis()
                def duration = (endTime - startTime) / 1000
                sendDiscordMessage("ğŸš¨ ì „ì²´ íŒŒì´í”„ë¼ì¸ ì‹¤íŒ¨!", "â±ï¸ ì‹¤í–‰ ì‹œê°„: ${duration}ì´ˆ", "RED")
            }
        }
    }
}